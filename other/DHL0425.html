<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <!-- leaflet css link  -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.1.0/css/v4-shims.min.css">
    <link rel="stylesheet" href="http://code.ionicframework.com/ionicons/1.5.2/css/ionicons.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
    <link rel="stylesheet" href="leaflet-panel-layers.css"/>
    <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootswatch/4.5.2/solar/bootstrap.min.css" /> -->

    <!-- 空間檢索 -->
    <!-- <link rel="stylesheet" href="D:\00-論文\02-系統程式\leaflet-search-master\src\leaflet-search.css" /> -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
   
    <link rel="stylesheet" href="D:\00-論文\02-系統程式\地點檢索器-leaflet-control-geocoder-master\leaflet-control-geocoder-master\dist\Control.Geocoder.css" />
    <link rel="stylesheet" href="D:\00-論文\02-系統程式\03時間軸-leaflet_hex_timeslider-main\static\nouislider.css">
    
    <!--  Leaflet MarkerCluster -->
    <link rel="stylesheet" href="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.css">
    <link rel="stylesheet" href="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.Default.css">

    <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css'
        rel='stylesheet' />
    
    <title>地理資訊探究模組</title>

    <style>
      html, body, #container{
        height: 100%;
        width: 100%;
      }

      body {
        margin: 0;
        padding: 0;
        /* display: flex; */
        /* align-items: stretch; */
      }

      .navbar{
        background-color: #24375a;
        z-index: 99999;
      }

      .navbar a{
        color: #f8f8f8;
      }

      .navbar li a{
        display:inline;
        text-decoration: none;
        width: 30px;
        border-radius: 0.25rem;
        margin-right:10px;
        padding: 5px;
      }
      
      .navbar li a:hover{
        border:3px solid #EEE;
      }

      #container{
        display: flex;
        height:fit-content;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }

      #map {
        position: relative;
        width: 100%;
        height: 100%;
        float: left;
      }
      
      p{
        color: rgb(10, 32, 104);
        font-family: Arial, Helvetica, sans-serif;
        font-weight: bold;
        font-size: 20px;
      }

      .sidebar{
        display: flex;
        background-color:#b6cffd;
        top: 0;
        width: 0;
        z-index: 5000;
        height: 100%;
        float:left;
       }  

      #search_panel {    
        background-color: #b6cffd;
        position: absolute;
        height: 100%;
        width: 250px;
        z-index: 4000;
        font-family: Arial, Helvetica, sans-serif;
        font-weight: bold; 
        float: left;
        opacity: 0.9;
      }

      #search_panel.active {    
        margin-left: -250px;
        height: 100%;
      }
 
      #location_panel {    
        display: none;
        background-color: #b6cffd;
        position: absolute;
        height: 100%;
        width: 250px;
        z-index: 4000;
        font-family: Arial, Helvetica, sans-serif;
        font-weight: bold; 
        float: left;
        opacity: 0.9;
      }

      #location_panel.active {    
        margin-left: -250px;
        height: 100%;
      }

      #list_panel {  
        display: none;  
        background-color: #b6cffd;
        position: relative;
        height: 100%;
        width: 250px;
        z-index: 4000;
        font-family: Arial, Helvetica, sans-serif;
        font-weight: bold; 
        float: left;
        opacity: 0.9;
      }

      #list_panel.active {    
        margin-left: -250px;
        height: 100%;
      }

      .panel-heading{
        width: 250px;
      }
      .panel-body{
        width: 250px;
      }
      .feature-row {
        cursor: pointer;
        width: 250px;
      }

      #chart_panel {    
        display: none;
        background-color: #b6cffd;
        position: absolute;
        height: 100%;
        width: 250px;
        z-index: 4000;
        font-family: Arial, Helvetica, sans-serif;
        font-weight: bold; 
        float: left;
        opacity: 0.9;
      }

      #chart_panel.active {    
        margin-left: -250px;
        height: 100%;
      }

      .collapse-btn{
        position: relative;
        margin-top: 4px;
        left: 210px;
        background-color: #f8f8f800;
        border-color: #f8f8f800;
      }

      input{
        outline-style: none;
        border: 0px;
        border-radius: 0.25rem;
      }

      #gis_search, #loc_search, #list_search{
        background-color: #24375a;
        color:#ffffff;
      }

      .leaflet-control-scale{
        position: relative;
      } 
      
      .timeline{
        z-index: 9999;
        position: "topleft";
        display: flex;
      }

      .panel-heading{
        width: 250px;
      }

      .feature-row {
        cursor: pointer;
        width: 250px;
      }

      .sidebar-table {
        position: absolute;
        width: 100%;
        top: 90px;
        bottom: 0px;
        font-size: 10px;
        font-weight: bold;
        text-align:justify-all;
        overflow: auto;
        background-color: #b6cffd;
      }
     
      tr:nth-child(odd) {background-color:#f4f4f5;}  
      tr:nth-child(even) {background-color:#b6cffde0;}

      .navbar-toggler{
        color: #ffffff;
      }

      @media (max-width: 450px){
        .navbar li a{
        height: 30px;
        font-size: 16px;
        }
      }

    </style>
  </head>

  <body> 

    <nav class="navbar navbar-expand-lg navbar-fixed-top">
      <div class="container-fluid" id="nav_header">
        <a class="navbar-brand" href="#"><i class="fas fa-globe-asia"></i>&nbsp;地理資訊探究模組</a>
<!-- 平板 -->
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#linkbar">
        <i class="fas fa-align-justify white"></i>
      </button>

<!-- 電腦 -->
        <div class="collapse navbar-collapse" id="linkbar">
          <ul class="navbar-nav me-auto">
            <li><a href="#search_panel" data-toggle="collapse" data-target=".navbar-collapse.in" id="search_btn">
              <i class="fas fa-search" aria-hidden="true"></i>&nbsp;屬性檢索</a>
            </li>
            <li><a href="#location_panel" data-toggle="collapse" data-target=".navbar-collapse.in" id="location_btn">
              <i class="fas fa-map-marker-alt" aria-hidden="true"></i>&nbsp;空間檢索</a>
            </li>
            <li><a href="#list_panel" data-toggle="collapse" data-target=".navbar-collapse.in" id="list_btn">
              <i class="fas fa-list" aria-hidden="true"></i>&nbsp;文本列表</a>
            </li>
            <li><a href="#chart_panel" data-toggle="collapse" data-target=".navbar-collapse.in" id="chart_btn">
              <i class="fas fa-chart-pie" aria-hidden="true"></i>&nbsp;統計圖表</a>
            </li>
          </ul>
        </div><!--/.navbar-collapse -->
      </div>
    </nav>

<div id="container">
    <div class="sidebar"> 

      <div id="search_panel">
        <button type="button" id="close_btn" class="btn btn-primary-outline collapse-btn">
          <i class="fas fa-times"></i>
        </button>
        <p class="col-md mt-2 text-body"><i class="fas fa-search" aria-hidden="true"></i>&nbsp;屬性檢索</p>
        <div class="col-md" id="timeline">
        <label for="keyword">時間軸</label>
          <div class="timeline" class="col-md"></div>
          <div id="slider-fit" class="col-md"></div>
          <div id="slider-date" class="col-md"></div>
          <div id="event-start" class="col-md"></div>
          <div id="event-end" class="col-md mb-2"></div>
        </div>

        <div class="col-md">
          <label for="keyword">關鍵字檢索</label>
          <input type="text" class="form-control-sm mb-2" id="keyword" placeholder=" 請輸入關鍵字"></div>

        <div class="col-md">
          <label for="eventtype">災例類型</label>
          <select class="form-control mb-2 selectpicker" id="eventtype" multiple data-live-search="true"> 
            <option>土石流</option>
            <option>崩塌</option>
            <option>山崩</option>
            <option>沖蝕</option>
            <option>地滑</option>
            <option>洪水</option>
          </select>
        </div>

        <div class="col-md">
          <label for="eventname">事件名稱</label>
          <select class="form-control mb-2 selectpicker" id="eventname" multiple data-live-search="true"> 
            <option>950609豪雨</option>
            <option>960604豪雨</option>
            <option>960809豪雨</option>
            <option>96聖帕颱風</option>
            <option>96其他</option>
            <option>96韋帕颱風</option>
            <option>96柯羅莎颱風</option>
            <option>97其他</option>
            <option>97卡玫基颱風</option>
            <option>97鳳凰颱風</option>
            <option>97辛樂克颱風</option>
            <option>97薔蜜颱風</option>
            <option>98其他</option>
            <option>98莫拉克颱風</option>
            <option>98芭瑪颱風</option>
            <option>99其他</option>
            <option>99萊羅克颱風</option>
            <option>99凡那比颱風</option>
            <option>990924豪雨</option>
            <option>991016豪雨</option>
            <option>99梅姬颱風</option>
            <option>1000719豪雨</option>
            <option>100南瑪都颱風</option>
            <option>1001001豪雨</option>
            <option>1010504豪雨</option>
            <option>1010610豪雨</option>
            <option>101蘇拉颱風</option>
            <option>101天秤颱風</option>
            <option>1020517豪雨</option>
            <option>1020602地震</option>
            <option>102其他</option>
            <option>102蘇力颱風</option>
            <option>102康芮颱風</option>
            <option>102天兔颱風</option>
            <option>102菲特颱風</option>
            <option>103哈吉貝颱風</option>
            <option>103麥德姆颱風</option>
            <option>103鳳凰颱風</option>
            <option>104其他</option>
            <option>104蘇迪勒颱風</option>
            <option>104杜鵑颱風</option>
            <option>105其他</option>
            <option>1050611豪雨</option>
            <option>105尼伯特颱風</option>
            <option>105莫蘭蒂颱風</option>
            <option>105梅姬颱風</option>
            <option>1060601豪雨</option>
            <option>1060613豪雨</option>
            <option>106尼莎暨海棠颱風</option>
            <option>107其他</option>
            <option>1070823熱帶低壓</option>
            <option>1080520豪雨</option>
            <option>1080611豪雨</option>
            <option>108其他</option>
            <option>108利奇馬颱風</option>
            <option>1080815豪雨</option>
            <option>1090522豪雨</option>
            <option>109其他</option>
          </select>
        </div>

        <div class="col-md">
          <button type="button" class="btn-sm" id="gis_search">查詢</button>
        </div>
      </div>

    <div id="location_panel">
      <button type="button" id="close_btn" class="btn btn-primary-outline collapse-btn">
        <i class="fas fa-times"></i>
      </button>

      <p class="col-md mt-2 text-body"><i class="fas fa-map-marker-alt" aria-hidden="true"></i>&nbsp;空間檢索</p>
      <div class="col-md" id="location_search">
        <label for="location">地點檢索</label>
        <input type="text" class="form-control-sm mb-2" id="location" placeholder="請輸入地點關鍵字"></div>

        <div class="col-md">
          <button type="button" class="btn-sm" id="loc_search">查詢</button>
        </div>
      </div>

    <div id="list_panel" class="panel panel-default">
      <button type="button" id="close_btn" class="btn btn-primary-outline collapse-btn">
        <i class="fas fa-times"></i>
      </button>
      <div class="panel-heading">
        <p class="col-md mt-2 text-body"><i class="fas fa-list" aria-hidden="true"></i>&nbsp;文本列表</p>
      </div>      
    
      <div class="sidebar-table">
        <table class="table table-hover" id="feature-list">
          <thead>
              <th>標題</th>
              <th>災例類型</th>
              <th></th>
          </thead>
          <tbody class="list"></tbody>
        </table>
      </div>
    </div>

    <div id="chart_panel">
      <button type="button" id="close_btn" class="btn btn-primary-outline collapse-btn">
        <i class="fas fa-times"></i>
      </button>
      <p class="col-md mt-2 text-body"><i class="fas fa-chart-pie" aria-hidden="true"></i>&nbsp;統計圖表</p>
        <div class="col-md">
          <!-- <label for="piechart_data">災例類型統計</label> -->
          <canvas id="piechart" width="400" height="400"></canvas>
            
        </div>

        <div class="col-md" id="barchart">
          <label for="barchart_data">災例類型統計</label>
            
          </div>
    
    </div>


    </div>
    <div id="map"></div>
  </div>

  </body>
</html>

<!-- leaflet js link  -->
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script> -->
<script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="crossorigin=""></script>
<!-- 列表 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.1.1/list.min.js"></script>

<!--  Leaflet MarkerCluster -->
<script src="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/leaflet.markercluster.js"></script>

<!-- panel-layer js -->
<script src="https://opengeo.tech/maps/leaflet-panel-layers/src/leaflet-panel-layers.js"></script>
<!-- <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script> -->

<!-- nouislider js --><!-- 
<script src="D:\00-論文\02-系統程式\03時間軸-leaflet_hex_timeslider-main\static\nouislider.js"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.0.1/nouislider.min.js"></script>

<!-- heatmap js -->
<!-- <script src="leaflet-heat.js"></script> -->

<!-- 空間檢索 -->
<!-- <script src="D:\00-論文\02-系統程式\leaflet-search-master\src\leaflet-search.js"></script> -->
<!-- <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script> -->
<script src="Control.Geocoder.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<!-- jquery link  -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>

<script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.1.1/build/ol.js"></script>

<script src="noUiSlider-master\documentation\assets\wNumb.js"></script>

<!-- chartjs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>

<!-- 災害潛勢data -->
<script src="DipSlope.js"></script>

<!-- leaflet geoserver request link  -->
<script src="lib/L.Geoserver.js"></script>


<script>
  $('select').selectpicker();
  var map = L.map("map").setView([23.97565, 120.9738819], 7);
osmLayer = new L.TileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
map.addLayer(osmLayer);
//map.zoomControl(L.control.zoom({position:"bottomright"}));
map.zoomControl.setPosition("bottomleft");
L.control.scale({position:'bottomright'}).addTo(map);


var geocoder = L.Control.geocoder({  
  defaultMarkGeocode: false, position: "topleft", collapsed: false, container:'#location_search'})
  .on('markgeocode', function(e) {
    var bbox = e.geocode.bbox;
    var poly = L.polygon([
      bbox.getSouthEast(),
      bbox.getNorthEast(),
      bbox.getNorthWest(),
      bbox.getSouthWest()
    ]).addTo(map);
    map.fitBounds(poly.getBounds());
  })
  .addTo(map);

$(document).on("click","#search_btn",function(){
 
  if($("#search_panel").css('display') == 'none'){
    $("#search_panel").show();
    $("#location_panel").hide();
    $("#list_panel").hide();
    $("#chart_panel").hide();
   }
  else{
    $("#search_panel").hide();
    $("#location_panel").hide();
    $("#list_panel").hide();
    $("#chart_panel").hide();
  };
});

$(document).on("click","#location_btn",function(){  

  if($("#location_panel").css('display') == 'none'){
    $("#location_panel").show();
    $("#search_panel").hide();
    $("#list_panel").hide();
    $("#chart_panel").hide();
   }
   else{
     $("#search_panel").hide();
     $("#location_panel").hide();
     $("#list_panel").hide();
     $("#chart_panel").hide();
  };
});

$(document).on("click","#list_btn",function(){
  
  if($('#list_panel').css('display') == 'none'){
    $("#list_panel").show();
    $("#search_panel").hide();
     $("#location_panel").hide();
     $("#chart_panel").hide();
  }
   else{
     $("#search_panel").hide();
     $("#location_panel").hide();
     $("#list_panel").hide();
     $("#chart_panel").hide();
    };
});

$(document).on("click","#chart_btn",function(){
  
   if($("#chart_panel").css('display') == 'none'){
     $("#chart_panel").show();
     $("#search_panel").hide();
     $("#location_panel").hide();
     $("#list_panel").hide();
  }
   else{
     $("#search_panel").hide();
     $("#location_panel").hide();
     $("#list_panel").hide();
     $("#chart_panel").hide();
    };
});

// $("#search_btn").click(function(){
//    $("#search_panel").toggleClass("active");
// });

// $("#location_btn").click(function(){
//    $("#location_panel").toggleClass("active");
// });

// $("#list_btn").click(function(){
//    $("#list_panel").toggleClass("active");
// });

// $("#chart_btn").click(function(){
//    $("#chart_panel").toggleClass("active");
// });

$(".collapse-btn").click(function(){
   $("#search_panel").hide();
   $("#location_panel").hide();
   $("#list_panel").hide();
   $("#chart_panel").hide();
});


var panel = L.control.panelLayers();


//======檢索條件=======
// var query;
query = function(){

query_array=[]  //將條件存成陣列

//時間軸-起始時間
// start_date= $('#event-start').text();
var Sd = $('#event-start').text();

  startdate_query = "Date after "+Sd+"T00:00:00Z";
  // query_array.push(startdate_query);  

//時間軸-結束時間
// end_date= $('#event-end').text();
var Ed = $('#event-end').text();
  enddate_query = "Date before "+Ed+"T00:00:00Z"+"";
  // query_array.push(enddate_query);

date_query = startdate_query + " AND " + enddate_query;
query_array.push(date_query);


_keyword = $( "#keyword" ).val(); 
var Kw = $( "#keyword" ).val(); //關鍵字檢索
if(!Kw ){
  console.log('沒有東西');
}
else{
  console.log(Kw);
  Kw_array = Kw.split(', ');
  Kw_array.forEach((element, index) => {
    Kw_array[index] = "'"+element + "'";
           });
  keyword_query = "Title Like '%"+ Kw +"%' OR Land Like '%"+ Kw +"%' OR Cause Like '%"+ Kw +"%' OR Place Like '%"+ Kw +"%' OR Resource Like '%"+ Kw +"%'";
  query_array.push(keyword_query);
}

// _eventtype=$( ".dropdown-toggle[data-id='eventtype']" ).attr('title');  //災例類型篩選
// _eventtype.split(', ');
// alert(_eventtype);

var Et = $( ".dropdown-toggle[data-id='eventtype']" ).attr('title');
if(Et =="Nothing selected"){                                    
console.log('沒有東西');
}
else{
  console.log(Et);
  Et_array = Et.split(', ');
  Et_array.forEach((element, index) => {
    Et_array[index] = "'"+element + "'";
           });
  Et_query = Et_array.join(', ');
  type_query = "Type IN ("+Et_query+")"; 
  query_array.push(type_query); 
}

// _eventname=$( ".dropdown-toggle[data-id='eventname']" ).attr('title');  //事件名稱篩選
// _eventname.split(', ');
// alert(_eventname);

var En = $( ".dropdown-toggle[data-id='eventname']" ).attr('title');
if(En =="Nothing selected"){                                    
console.log('沒有東西');
}
else{
  console.log(En);
  En_array = En.split(', ');
  En_array.forEach((element, index) => {
    En_array[index] = "'"+element + "'";
           });
  En_query = En_array.join(', ');
  event_query = "Event_name IN ("+En_query+")"; 
  query_array.push(event_query);
}

if(query_array.length > 1){
  query_list = query_array.join(' OR ');
  console.log(query_list);
}else if(query_array.length = 1){
  query_list = query_array[0];
  console.log(query_list);
}

//query_list = query_array.join(' OR ');
panelLayers.removeLayer(geodata);
geodata = square("full_dfdata", query_list);
//var input_data = start_date + end_date + Kw + Et + En;
//panelLayers.removeLayer(geodata);
panelLayers.addOverlay({layer:geodata, active:true}, '重大土砂災例', '文本圖層');
_damage = $( ".filter-option-inner-inner" ).text();
}

//======檢索條件=======

//======檢索按鈕=======
$('#gis_search').click(function(){

query_array=[]  //將條件存成陣列

// $('#event-start').text(); //時間軸-起始時間
// start_date= $('#event-start').text();
// // start_date_filter = start_date.replace(/-/g, "/");
// // alert(start_date_filter);
// // console.log(start_date_filter) +'T00:00:00Z';
// var Sd = $('#event-start').text();
// if(Sd ==""){
//   console.log(Sd);
// }
// else{
//   startdate_query = "Date after "+Sd+'T00:00:00Z'+"";
//   // query_array.push(startdate_query);
// }


// $('#event-end').text(); //時間軸-結束時間
// end_date= $('#event-end').text();
// // end_date_filter = end_date.replace(/-/g, "/");
// // alert(end_date_filter);
// // console.log(end_date_filter) +'T00:00:00Z';
// var Ed = $('#event-end').text();

// if(Ed ==""){
//   console.log(Ed);
// }
// else{
//   enddate_query = "Date before "+Ed+'T00:00:00Z'+"";
//   // query_array.push(enddate_query);
// }

// date_query = startdate_query + " AND " + enddate_query;
// query_array.push(date_query);


_keyword = $( "#keyword" ).val(); 
var Kw = $( "#keyword" ).val(); //關鍵字檢索
if(!Kw ){
  console.log('沒有東西');
}
else{
  console.log(Kw);
  Kw_array = Kw.split(', ');
  Kw_array.forEach((element, index) => {
    Kw_array[index] = "'"+element + "'";
           });
  keyword_query = "Title Like '%"+ Kw +"%' OR Land Like '%"+ Kw +"%' OR Cause Like '%"+ Kw +"%' OR Place Like '%"+ Kw +"%' OR Resource Like '%"+ Kw +"%'";
  query_array.push(keyword_query);
}

// _eventtype=$( ".dropdown-toggle[data-id='eventtype']" ).attr('title');  //災例類型篩選
// _eventtype.split(', ');
// alert(_eventtype);

var Et = $( ".dropdown-toggle[data-id='eventtype']" ).attr('title');
if(Et =="Nothing selected"){                                    
console.log('沒有東西');
}
else{
  console.log(Et);
  Et_array = Et.split(', ');
  Et_array.forEach((element, index) => {
    Et_array[index] = "'"+element + "'";
           });
  Et_query = Et_array.join(', ');
  type_query = "Type IN ("+Et_query+")"; 
  query_array.push(type_query); 
}

// _eventname=$( ".dropdown-toggle[data-id='eventname']" ).attr('title');  //事件名稱篩選
// _eventname.split(', ');
// alert(_eventname);

var En = $( ".dropdown-toggle[data-id='eventname']" ).attr('title');
if(En =="Nothing selected"){                                    
console.log('沒有東西');
}
else{
  console.log(En);
  En_array = En.split(', ');
  En_array.forEach((element, index) => {
    En_array[index] = "'"+element + "'";
           });
  En_query = En_array.join(', ');
  event_query = "Event_name IN ("+En_query+")"; 
  query_array.push(event_query);
}

if(query_array.length > 1){
  query_list = query_array.join(' AND ');
  console.log(query_list);
}else if(query_array.length = 1){
  query_list = query_array[0];
  console.log(query_list);
}


//query_list = query_array.join(' OR ');
// pieChart.destroy();
panelLayers.removeLayer(geodata);
geodata = square("full_dfdata", query_list);
// $.when(square("full_dfdata", query_list))
// .then(function(x){panelLayers.addOverlay({layer:x, active:true}, '重大土砂災例', '文本圖層');
// occurrences={};
//  typelabel=[];
// typevalue=[];
//  for (var i = 0; i < type_count_array.length; i++){
//     occurrences[type_count_array[i]] = (occurrences[type_count_array[i]] + 1) || 1;
//   }
//   console.log(occurrences);
//   for (const [key, value] of Object.entries(occurrences)) {
//       typelabel.push(key);
//       typevalue.push(value);
//     };
//     console.log(occurrences);
//                                                      });
//var input_data = start_date + end_date + Kw + Et + En;
//panelLayers.removeLayer(geodata);
panelLayers.addOverlay({layer:geodata, active:true}, '重大土砂災例', '文本圖層');
setTimeout(() => {
  typeCount(type_count_array);
}, "3000")

//pieChart.destroy();
// typeCount(type_count_array);
// pieChart.data.labels = typelabel
// pieChart.data.datasets[0].data=typevalue;
// pieChart.update('active');
// //_damage = $( ".filter-option-inner-inner" ).text();   
});

//======條件檢索end======
// chart_update=function(){
// pieChart.destroy();
// //typeCount(type_count_array);
// pieChart.data.labels = typelabel
// pieChart.data.datasets[0].data=typevalue;
// pieChart.update('active');
// }




window.onload=function(){
//時間軸動態資料
$('.noUi-origin').mouseup(function(){
// alert('aaaaaa');
query();
});
typeCount(type_count_array);
}

var type_count_array;
//========文本圖層========
function square(full_dfdata_layer,cql_filter="INCLUDE") {
//alert(cql_filter);
type_count_array=[];
var dflayer = L.Geoserver.wfs("http://exp-geoserver.dlll.nccu.edu.tw:5081/geoserver/wms", {   
      layers: full_dfdata_layer,
      //CQL_FILTER: "X==120.649622",
      //CQL_FILTER: "Cause LIKE '%+ +%' OR Time LIKE '%+ +%' OR Type LIKE '%+ +%' OR Event_name LIKE '%+ +%'",
      //CQL_FILTER: "Type IN ('沖蝕', '地滑')",
      
      CQL_FILTER: cql_filter,

      pointToLayer: function (feature, latlng) {
        return L.marker(latlng, {
          icon: L.icon({
            iconUrl: "landslide.png",
            iconSize: [24, 24],
            iconAnchor: [12, 12],
            popupAnchor: [0, -25]
          }),
        });
      },

    onEachFeature: function (feature, layer) {
    if (feature.properties) {
      var content = "<table class='table table-striped table-bordered table-condensed'>" + 
      "<tr><th>ID</th><td>" + feature.properties.ID + "</td></tr>" + 
      "<tr><th>檔案名稱</th><td>" + feature.properties.Data_name + "</td></tr>" +  
      "<tr><th>災例標題</th><td>" + feature.properties.Title + "</td></tr>" +
      "<tr><th>事件名稱</th><td>" + feature.properties.Event_name + "</td></tr>" +
      "<tr><th>災例類型</th><td>" + feature.properties.Type + "</td></tr>" +
      "<tr><th>發生日期</th><td>" + feature.properties.Date + "</td></tr>" +
      "<tr><th>發生時間</th><td>" + feature.properties.Time + "</td></tr>" +
      "<tr><th>發生原因</th><td>" + feature.properties.Cause + "</td></tr>" +
      "<tr><th>土地權屬</th><td>" + feature.properties.Land + "</td></tr>" +
      "<tr><th>縣市</th><td>" + feature.properties.County + "</td></tr>" +
      "<tr><th>鄉鎮</th><td>" + feature.properties.Town + "</td></tr>" +
      "<tr><th>村里</th><td>" + feature.properties.Village + "</td></tr>" +
      "<tr><th>災例地點</th><td>" + feature.properties.Place + "</td></tr>" +
      "<tr><th>X</th><td>" + feature.properties.X + "</td></tr>" +
      "<tr><th>Y</th><td>" + feature.properties.Y + "</td></tr>" +
      "<tr><th>資料來源</th><td>" + feature.properties.Resource + "</td></tr>"
      "</table>";
    layer.bindPopup(content , {maxHeight: 300});
    type_count_array.push(feature.properties.Type);
    //console.log(type_count_array);
  
  layer.on({
        click: function (e) {
          $("#feature-title").html(feature.properties.Title);
          $("#feature-info").html(content);
        }
      });
    // $("#feature-list tbody").append('<tr class="feature-row" id="' + L.stamp(layer) + '" lat="' + layer.getLatLng().lat + '" lng="' + layer.getLatLng().lng + '"><td style="vertical-align: middle;"><img width="16" height="18" src="assets/img/theater.png"></td><td class="feature-name">' + layer.feature.properties.Title + '</td><td style="vertical-align: middle;"><i class="fa fa-chevron-right pull-right"></i></td></tr>'); 
    $("#feature-list tbody").append('<tr class="feature-row" id="' + L.stamp(layer) + '" lat="' + layer.getLatLng().lat + '" lng="' + layer.getLatLng().lng + '"><td class="feature-name">' + layer.feature.properties.Title + '</td><td class="feature-type">' + layer.feature.properties.Type + '</td><td style="vertical-align: middle;"><i class="fa fa-chevron-right pull-right"></i></td></tr>');
    }
  },
});

return dflayer; 
}
geodata = square("full_dfdata");
//========文本圖層end========

//=======文本列表功能=========
var featureList =[]
$(document).on("click", ".feature-row", function(e) {
  $(document).off("mouseout", ".feature-row", clearHighlight);
  sidebarClick(parseInt($(this).attr("id"), 10));
});

$(document).on("mouseout", ".feature-row", clearHighlight);

function clearHighlight() {
}

function sidebarClick(id) {
  var layer =geodata.getLayer(id);
  map.setView([layer.getLatLng().lat, layer.getLatLng().lng], 12);
  layer.fire("click");
  /* Hide sidebar and go to the map on small screens */
  if (document.body.clientWidth <= 767) {
    $("#list_panel").hide();
    map.invalidateSize();
  }
}

function syncSidebar() {
  /* Empty sidebar features */
  $("#feature-list tbody").empty();
  /* Loop through theaters layer and add only features which are in the map bounds */
  geodata.eachLayer(function (layer) {
    if (map.hasLayer(geodata)) {
      if (map.getBounds().contains(layer.getLatLng())) {
        $("#feature-list tbody").append('<tr class="feature-row" id="' + L.stamp(layer) + '" lat="' + layer.getLatLng().lat + '" lng="' + layer.getLatLng().lng + '"><td class="feature-name">' + layer.feature.properties.Title + '</td><td class="feature-type">' + layer.feature.properties.Type + '</td><td style="vertical-align: middle;"><i class="fa fa-chevron-right pull-right"></i></td></tr>');
      }
    }
  });
  /* Update list.js featureList */
  featureList = new List("features", {
      valueNames: ["feature-name","feature-type"]
    });
  }

/* Filter sidebar feature list to only show features in current map bounds */
map.on('zoom move', function (e) {
  syncSidebar();
});
var pieChart;
//======圖表陣列========
function typeCount(type_count_array){
  console.log(typeof type_count_array)
  typelabel=[];
typevalue=[];
console.log(type_count_array);
  var occurrences = {};for (var i = 0; i < type_count_array.length; i++)
    occurrences[type_count_array[i]] = (occurrences[type_count_array[i]] + 1) || 1;
 // occurrences = count_array.reduce(function (acc, curr) {
 //  console.log('wwwwwww');
 //      console.log(acc);
 //      return acc[curr] ? ++acc[curr] : acc[curr] = 1, acc
 //    }, {});
  console.log(occurrences);
  for (const [key, value] of Object.entries(occurrences)) {
      typelabel.push(key);
      typevalue.push(value);
    };
//var ctx = document.getElementById('pieChart');
console.log('222222222222');
console.log(typelabel);
console.log(typevalue);
var ctx =document.getElementById('piechart');
if(pieChart !== undefined){
  pieChart.destroy();
}
//console.log(typevalue);
pieChart = new Chart(ctx, {
  type: 'doughnut',
  options: {
    responsive: true,
    plugins: {
      legend: {
        position: 'top',
      },
      title: {
        display: true,
        text: '災例類型統計',
      }
    }
  },
  data: {
      labels: typelabel,
      datasets: [{
        data: typevalue
      }]
    }
  });
};


  
  // const data = {
  //   labels: typelabel,
  //   datasets: [{
  //     label: '災例類型統計',
  //     data: typevalue,
  //     // backgroundColor: [
  //     //   'rgb(255, 99, 132)',
  //     //   'rgb(54, 162, 235)',
  //     //   'rgb(255, 205, 86)'
  //     // ],
  //     // hoverOffset: 4
  //   }]
  // };
//=========圖表結束========
//=====圖層======
var baseLayers = [
	{
		group: "基本底層",
		layers: [
    {
		name: "Open Street Map",
		layer: osmLayer
    },
    {
      name: "臺灣通用電子地圖",
      layer: L.tileLayer("https://wmts.nlsc.gov.tw/wmts/EMAP/default/EPSG:3857/{z}/{y}/{x}")
    }
		]
	}
];
var overLayers = [
{
		group: "文本圖層", //WMS Layers
		layers: [
    {
		active: true,
		name: "重大土砂災例",
    layer: geodata,
		}, //end first
		]
	},
  {
		group: "治山防災工程", //WMS Layers
		layers: [
    {
				name: "106-107年",
				// icon: '<i class="fas fa-hard-hat"></i>',
				layer: L.Geoserver.wfs("http://exp-geoserver.dlll.nccu.edu.tw:5081/geoserver/wms", {
        layers: "106-107",
    
        pointToLayer: function (feature, latlng) {
        return L.marker(latlng, {
          icon: L.icon({
            iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png",
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
          }),
        });
      },

      onEachFeature: function (feature, layer) {
      if (feature.properties) {
        //console.log(feature.properties.description);
        html = $($.parseHTML(feature.properties.description));
        //_td=html.find('td').eq(25).text();
        _tr=html.find('tr').slice(2);
        //console.log(html.find('td'));
        var _element_content="";
        $(_tr).each(function() {
          _element_content = _element_content+ "<tr><th>"+$(this).find('td').eq(0).text()+"</th><td>" + $(this).find('td').eq(1).text() + "</td></tr>";
          //console.log( $(this).find('td').eq(0).text()+ ": " + $(this).find('td').eq(1).text());
        });
        var content1 = "<table class='table table-striped table-bordered table-condensed'>" + "<tr><th>名稱</th><td>" + feature.properties.Name + "</td></tr>"; 
        //"<tr><th>描述</th><td>" + feature.properties.description + "</td></tr>"+
        var _end = "</table>";
        content1 = content1+_element_content+_end;
        layer.bindPopup(content1 , {maxHeight: 300});}}
        })
			},
      {
				name: "108年",
				layer: L.Geoserver.wfs("http://exp-geoserver.dlll.nccu.edu.tw:5081/geoserver/wms", {
        layers: "108",

        pointToLayer: function (feature, latlng) {
          return L.marker(latlng, {
            icon: L.icon({
              iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png",
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34]
            }),
          });
        },
      
        onEachFeature: function (feature, layer) {
          if (feature.properties) {
             //console.log(feature.properties.description);
             html = $($.parseHTML(feature.properties.description));
             //_td=html.find('td').eq(25).text();
             _tr=html.find('tr').slice(2);
             //console.log(html.find('td'));
             var _element_content="";
             $(_tr).each(function() {
               _element_content = _element_content+ "<tr><th>"+$(this).find('td').eq(0).text()+"</th><td>" + $(this).find('td').eq(1).text() + "</td></tr>";
               //console.log( $(this).find('td').eq(0).text()+ ": " + $(this).find('td').eq(1).text());
             });
             var content2 = "<table class='table table-striped table-bordered table-condensed'>" + "<tr><th>名稱</th><td>" + feature.properties.Name + "</td></tr>"; 
             //"<tr><th>描述</th><td>" + feature.properties.description + "</td></tr>"+
             var _end = "</table>";
             content2 = content2+_element_content+_end;
             layer.bindPopup(content2 , {maxHeight: 300});}}
        })
			},
      {
				name: "109年",
				layer: L.Geoserver.wfs("http://exp-geoserver.dlll.nccu.edu.tw:5081/geoserver/wms", {
        layers: "109",

        pointToLayer: function (feature, latlng) {
          return L.marker(latlng, {
            icon: L.icon({
              iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png",
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34]
            }),
          });
        },

        onEachFeature: function (feature, layer) {
          if (feature.properties) {
            console.log(feature.properties.description);
            html = $($.parseHTML(feature.properties.description));
            //_td=html.find('td').eq(25).text();
            _tr=html.find('tr').slice(2);
            //console.log(html.find('td'));
            var _element_content="";
            $(_tr).each(function() {
              _element_content = _element_content+ "<tr><th>"+$(this).find('td').eq(0).text()+"</th><td>" + $(this).find('td').eq(1).text() + "</td></tr>";
              //console.log( $(this).find('td').eq(0).text()+ ": " + $(this).find('td').eq(1).text());
            });
            var content3 = "<table class='table table-striped table-bordered table-condensed'>" + "<tr><th>名稱</th><td>" + feature.properties.Name + "</td></tr>"; 
            //"<tr><th>描述</th><td>" + feature.properties.description + "</td></tr>"+
            var _end = "</table>";
            content3 = content3+_element_content+_end;
            layer.bindPopup(content3 , {maxHeight: 300});}}
})
			},
      {
				name: "110年",
				layer: L.Geoserver.wfs("http://exp-geoserver.dlll.nccu.edu.tw:5081/geoserver/wms", {
        layers: "110",

        pointToLayer: function (feature, latlng) {
          return L.marker(latlng, {
            icon: L.icon({
              iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png",
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34]
            }),
          });
        },

        onEachFeature: function (feature, layer) {
          if (feature.properties) {
            console.log(feature.properties.description);
            html = $($.parseHTML(feature.properties.description));
            //_td=html.find('td').eq(25).text();
            _tr=html.find('tr').slice(2);
            //console.log(html.find('td'));
            var _element_content="";
            $(_tr).each(function() {
              _element_content = _element_content+ "<tr><th>"+$(this).find('td').eq(0).text()+"</th><td>" + $(this).find('td').eq(1).text() + "</td></tr>";
              //console.log( $(this).find('td').eq(0).text()+ ": " + $(this).find('td').eq(1).text());
            });
            var content4 = "<table class='table table-striped table-bordered table-condensed'>" + "<tr><th>名稱</th><td>" + feature.properties.Name + "</td></tr>"; 
            //"<tr><th>描述</th><td>" + feature.properties.description + "</td></tr>"+
            var _end = "</table>";
            content4 = content4+_element_content+_end;
            layer.bindPopup(content4 , {maxHeight: 300});}}
})
			},
		]
	},
  {
		group: "坡地災害潛勢圖層", //API介接
		layers: [
    {
      name: "土石流潛勢溪流",
				layer: L.Geoserver.wfs("http://exp-geoserver.dlll.nccu.edu.tw:5081/geoserver/wms", {
        layers: "debrisstream1726",
        onEachFeature: function (feature, layer) {
          if (feature.properties) {
            html = $($.parseHTML(feature.properties.description));
            //_td=html.find('td').eq(25).text();
            _tr=html.find('tr').slice(2);
            //console.log(html.find('td'));
            var _element_content="";
            $(_tr).each(function() {
              _element_content = _element_content+ "<tr><th>"+$(this).find('td').eq(0).text()+"</th><td>" + $(this).find('td').eq(1).text() + "</td></tr>";
              //console.log( $(this).find('td').eq(0).text()+ ": " + $(this).find('td').eq(1).text());
            });
            var content5 = "<table class='table table-striped table-bordered table-condensed'>" + 
              "<tr><th>土石流潛勢溪流編號</th><td>" + feature.properties.Debrisno + "</td></tr>" +
              "<tr><th>名稱</th><td>" + feature.properties.Name + "</td></tr>" +
              "<tr><th>主要所在縣市</th><td>" + feature.properties.County01 + "</td></tr>" +
              "<tr><th>主要所在鄉鎮</th><td>" + feature.properties.Town01 + "</td></tr>" +
              "<tr><th>主要所在村里</th><td>" + feature.properties.Vill01 + "</td></tr>" +
              "<tr><th>地標</th><td>" + feature.properties.Mark + "</td></tr>" +
              "<tr><th>主要道路名稱</th><td>" + feature.properties.Roadname + "</td></tr>" +
              "<tr><th>保全住戶戶數級距</th><td>" + feature.properties.TRes_Class + "</td></tr>" +
              "<tr><th>風險等級</th><td>" + feature.properties.Risk + "</td></tr>" +
              "<tr><th>管理分屬</th><td>" + feature.properties.Owner + "</td></tr>" +
              "<tr><th>類型</th><td>" + feature.properties.Type + "</td></tr>";
            var _end = "</table>";
            content5 = content5+_element_content+_end;
            layer.bindPopup(content5 , {maxHeight: 300});}}
        })
    },
    {
      name: "土石流潛勢溪流影響範圍",
				layer: L.Geoserver.wfs("http://exp-geoserver.dlll.nccu.edu.tw:5081/geoserver/wms", {
        layers: "debris1726",
        color:"#e02c1e",
        onEachFeature: function (feature, layer) {
          if (feature.properties) {
            html = $($.parseHTML(feature.properties.description));
            //_td=html.find('td').eq(25).text();
            _tr=html.find('tr').slice(2);
            //console.log(html.find('td'));
            var _element_content="";
            $(_tr).each(function() {
              _element_content = _element_content+ "<tr><th>"+$(this).find('td').eq(0).text()+"</th><td>" + $(this).find('td').eq(1).text() + "</td></tr>";
              //console.log( $(this).find('td').eq(0).text()+ ": " + $(this).find('td').eq(1).text());
            });
            var content5 = "<table class='table table-striped table-bordered table-condensed'>" + 
              "<tr><th>土石流潛勢溪流編號</th><td>" + feature.properties.Debrisno + "</td></tr>" +
              "<tr><th>主要所在縣市</th><td>" + feature.properties.County + "</td></tr>" +
              "<tr><th>主要所在鄉鎮</th><td>" + feature.properties.Town + "</td></tr>" +
              "<tr><th>主要所在村里</th><td>" + feature.properties.Vill + "</td></tr>" +
              "<tr><th>保全住戶地址</th><td>" + feature.properties.Address + "</td></tr>" +
              "<tr><th>影響範圍內保全住戶總數</th><td>" + feature.properties.Total_Res + "</td></tr>" +
              "<tr><th>影響範圍內保全住戶戶數級距</th><td>" + feature.properties.Res_Class + "</td></tr>" +
              "<tr><th>風險等級</th><td>" + feature.properties.Risk + "</td></tr>" ;
            var _end = "</table>";
            content5 = content5+_element_content+_end;
            layer.bindPopup(content5 , {maxHeight: 300});}}
        })
    },
    {
			 name: "地質圖",
			 layer:L.tileLayer('https://landslide.geologycloud.tw/jlwmts/jetlink/gm50000/GoogleMapsCompatible/{z}/{x}/{y}')
    },
    // {
    //    name: "順向坡",
    //    layer:L.tileLayer('https://landslide.geologycloud.tw/jlwmts/jetlink/Dislope/GoogleMapsCompatible/{z}/{x}/{y}')
    // },
    {
       name: "順向坡",
       layer: L.geoJSON(DipSlope, {
       color: "#CC7722",
       onEachFeature:function (feature, layer) {
          if (feature.properties) {
            console.log(feature.properties.MAP_NAME);
            layer.bindPopup(feature.properties.MAP_NAME);
          }
        }
       }),
    },
		]
	},
  {
    group: "套疊圖層",
		layers: [
    {
				name: "縣市界",
				layer:L.tileLayer('https://wmts.nlsc.gov.tw/wmts/CITY/default/EPSG:3857/{z}/{y}/{x}')
		},
		{
		  	name: "鄉鎮區界",
				layer:L.tileLayer('https://wmts.nlsc.gov.tw/wmts/TOWN/default/EPSG:3857/{z}/{y}/{x}')
		},
		{
				name: "村里界",
				layer:L.tileLayer('https://wmts.nlsc.gov.tw/wmts/Village/default/EPSG:3857/{z}/{y}/{x}')
		},
    {
        name: "1996年【SPOT衛星影像】",
				layer:L.tileLayer('https://data.csrsr.ncu.edu.tw/SP/SP1996NC_3857/{z}/{x}/{y}.png')
    },
    {
        name: "1997年【SPOT衛星影像】",
				layer:L.tileLayer('https://data.csrsr.ncu.edu.tw/SP/SP1997NC_3857/{z}/{x}/{y}.png')
    },
    {
        name: "1998年【SPOT衛星影像】",
				layer:L.tileLayer('https://data.csrsr.ncu.edu.tw/SP/SP1998NC_3857/{z}/{x}/{y}.png')
    },
    {
        name: "1999年【SPOT衛星影像】",
				layer:L.tileLayer('https://data.csrsr.ncu.edu.tw/SP/SP1999NC_3857/{z}/{x}/{y}.png')
    },
    {
        name: "2000年【SPOT衛星影像】",
				layer:L.tileLayer('https://data.csrsr.ncu.edu.tw/SP/SP2000NC_3857/{z}/{x}/{y}.png')
    },
    {
        name: "2001年【SPOT衛星影像】",
				layer:L.tileLayer('https://data.csrsr.ncu.edu.tw/SP/SP2001NC_3857/{z}/{x}/{y}.png')
    },
    {
        name: "2002年【SPOT衛星影像】",
				layer:L.tileLayer('https://data.csrsr.ncu.edu.tw/SP/SP2002NC_3857/{z}/{x}/{y}.png')
    },
    {
        name: "2003年【SPOT衛星影像】",
				layer:L.tileLayer('https://data.csrsr.ncu.edu.tw/SP/SP2003NC_3857/{z}/{x}/{y}.png')
    },
    {
        name: "2004年【SPOT衛星影像】",
				layer:L.tileLayer('https://data.csrsr.ncu.edu.tw/SP/SP2004NC_3857/{z}/{x}/{y}.png')
    },
    {
        name: "2005年【SPOT衛星影像】",
				layer:L.tileLayer('https://data.csrsr.ncu.edu.tw/SP/SP2005NC_3857/{z}/{x}/{y}.png')
    },
    {
        name: "2006年【SPOT衛星影像】",
				layer:L.tileLayer('https://data.csrsr.ncu.edu.tw/SP/SP2006NC_3857/{z}/{x}/{y}.png')
    },
    {
        name: "2007年【SPOT衛星影像】",
				layer:L.tileLayer('https://data.csrsr.ncu.edu.tw/SP/SP2007NC_3857/{z}/{x}/{y}.png')
    },
    {
        name: "2008年【SPOT衛星影像】",
				layer:L.tileLayer('https://data.csrsr.ncu.edu.tw/SP/SP2008NC_3857/{z}/{x}/{y}.png')
    },
    {
        name: "2009年【SPOT衛星影像】",
				layer:L.tileLayer('https://data.csrsr.ncu.edu.tw/SP/SP2009NC_3857/{z}/{x}/{y}.png')
    },
    {
        name: "2010年【SPOT衛星影像】",
				layer:L.tileLayer('https://data.csrsr.ncu.edu.tw/SP/SP2010NC_3857/{z}/{x}/{y}.png')
    },
    {
        name: "2011年【SPOT衛星影像】",
				layer:L.tileLayer('https://data.csrsr.ncu.edu.tw/SP/SP2011NC_3857/{z}/{x}/{y}.png')
    },
    {
        name: "2012年【SPOT衛星影像】",
				layer:L.tileLayer('https://data.csrsr.ncu.edu.tw/SP/SP2012NC_3857/{z}/{x}/{y}.png')
    },
    {
        name: "2013年【SPOT衛星影像】",
				layer:L.tileLayer('https://data.csrsr.ncu.edu.tw/SP/SP2013NC_3857/{z}/{x}/{y}.png')
    },
    {
        name: "2014年【SPOT衛星影像】",
				layer:L.tileLayer('https://data.csrsr.ncu.edu.tw/SP/SP2014NC_3857/{z}/{x}/{y}.png')
    },
    {
        name: "2015年【SPOT衛星影像】",
				layer:L.tileLayer('https://data.csrsr.ncu.edu.tw/SP/SP2015NC_3857/{z}/{x}/{y}.png')
    },
    {
        name: "2016年【SPOT衛星影像】",
				layer:L.tileLayer('https://data.csrsr.ncu.edu.tw/SP/SP2016NC_3857/{z}/{x}/{y}.png')
    },
    {
        name: "2017年【SPOT衛星影像】",
				layer:L.tileLayer('https://data.csrsr.ncu.edu.tw/SP/SP2017NC_3857/{z}/{x}/{y}.png')
    },
    {
        name: "2018年【SPOT衛星影像】",
				layer:L.tileLayer('https://data.csrsr.ncu.edu.tw/SP/SP2018NC_3857/{z}/{x}/{y}.png')
    },
    {
        name: "2019年【SPOT衛星影像】",
				layer:L.tileLayer('https://data.csrsr.ncu.edu.tw/SP/SP2019NC_3857/{z}/{x}/{y}.png')
    },
    {
        name: "2020年【SPOT衛星影像】",
				layer:L.tileLayer('https://data.csrsr.ncu.edu.tw/SP/SP2020NC_3857/{z}/{x}/{y}.png')
    },
    ]
  }
];

var panelLayers = new L.Control.PanelLayers(baseLayers, overLayers, {
	// compact: true,
	// collapsed: true,
	collapsibleGroups: true,
});

map.addControl(panelLayers);


//點任意位置顯示訊息方塊與經緯度座標
  var popup = L.popup();

  function onMapClick(e) {
  popup
    .setLatLng(e.latlng)
    .setContent("經緯度座標：" + e.latlng.toString())
    .openOn(map);
  }

map.on('click', onMapClick);


//時間軸
var dateSlider = document.getElementById('slider-date');

function timestamp(str) {
    return new Date(str).getTime();
}

noUiSlider.create(dateSlider, {
// Create two timestamps to define a range.
    range: {
        min: timestamp('2006'),
        max: timestamp('2021')
    },

// Steps of one week
    step: 7 * 24 * 60 * 60 * 1000,

// Two more timestamps indicate the handle starting positions.
    start: [timestamp('2006'), timestamp('2021')],

// No decimals
    format: wNumb({
        decimals: 0
    }),
    connect: true,
});

var dateValues = [
    document.getElementById('event-start'),
    document.getElementById('event-end')
];

var formatter = new Intl.DateTimeFormat('fr-CA',{ year:'numeric',month:'2-digit',day:'2-digit'});

dateSlider.noUiSlider.on('update', function (values, handle) {
    dateValues[handle].innerHTML = formatter.format(new Date(+values[handle]));
});

//文本列表

</script>